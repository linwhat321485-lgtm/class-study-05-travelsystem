<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.css">
    <title>新增旅遊套票 - work07</title>
  </head>
  <body>
    <section class="container py-10">
      <div class="row pt-9 pb-8 justify-content-center shadow-sm">
        <div class="col-4">
          <div>
            <img src="../assets/images/site-info/main_img.png" alt="" class="img-fluid">
          </div>
          <div>
            <img src="../assets/images/site-info/logo.png" alt="" class="img-fluid">
          </div>
        </div>
        <div class="col-4">
          <div class="border-bottom border-3 border-primary-400 mb-6">
            <h1 class="h4 text-primary-400">新增旅遊套票</h1>
          </div>
          <form id="ticketForm" class="d-flex flex-column gap-4 needs-validation">
            <div >
              <div class="d-flex align-items-center ticketInput">
                <label for="ticketName" class="label-sm text-primary-400 me-5">套票名稱</label>
                <input type="text" 
                id="ticketName" 
                name="name" 
                class="form-control border-bottom border-primary-400 rounded-bottom-0" 
                placeholder="請填寫套票名稱（限 15 字）"
                maxlength="15">
              </div>
              <p id="ticketNameError" class="text-danger small text-end d-none">填寫錯誤！</p>
            </div>
            <div>
              <div class="d-flex align-items-center ticketInput">
                <label for="imgUrl" class="label-sm text-primary-400 me-5">圖片網址</label>
                <input type="text" 
                id="imgUrl" 
                name="imgUrl" 
                class="form-control border-bottom border-primary-400 rounded-bottom-0" 
                placeholder="請填寫圖片網址">
              </div>
              <p id="ticketImgUrlError" class="text-danger small text-end d-none">填寫錯誤！</p>
            </div>
            <div>
              <div class="d-flex align-items-center ticketInput">
                <label for="areaSelect" class="label-sm text-primary-400 me-5">景點地區</label>
                <select name="area" 
                id="areaSelect" 
                class="form-select border-bottom border-primary-400 rounded-bottom-0"  
                aria-label="select" 
                aria-placeholder="請選擇景點地區">
                  <option selected disabled hidden>請選擇景點地區</option>
                  <option value="台北">台北</option>
                  <option value="台中">台中</option>
                  <option value="高雄">高雄</option>
                </select>
              </div>
              <p id="ticketAreaError" class="text-danger small text-end d-none">未選擇地區！</p>
            </div>
            <div>
              <div class="d-flex align-items-center ticketInput">
                <label for="ticketPrice" class="label-sm text-primary-400 me-5">套票金額</label>
                <input type="number" 
                name="price" 
                class="form-control border-bottom border-primary-400 rounded-bottom-0" 
                id="ticketPrice" 
                placeholder="請填寫套票金額">
              </div>
              <p id="ticketPriceError" class="text-danger small text-end d-none">填寫錯誤！</p>
            </div>
            <div>
              <div class="d-flex align-items-center ticketInput">
                <label for="ticketGroup" class="label-sm text-primary-400 me-5">套票組數</label>
                <input type="number" 
                name="group" 
                class="form-control border-bottom border-primary-400 rounded-bottom-0" 
                id="ticketGroup" 
                placeholder="請填寫套票組數">
              </div>
              <p id="ticketGroupError" class="text-danger small text-end d-none">填寫錯誤！</p>
            </div>
            <div>
              <div class="d-flex align-items-center ticketInput">
                <label for="ticketRate" class="label-sm text-primary-400 me-5">套票星級</label>
                <input type="number" 
                name="rate" 
                class="form-control border-bottom border-primary-400 rounded-bottom-0" 
                id="ticketRate" 
                min="1" max="10" 
                placeholder="請填寫套票星級（1~10）">
              </div>
              <p id="ticketRateError" class="text-danger small text-end d-none">填寫錯誤！（請填寫數字1~10）</p>
            </div>
            <div>
              <div class="d-flex align-items-start ticketInput">
                <label for="ticketDescribe" class="label-sm text-primary-400 me-5 py-2">套票描述</label>
                <textarea name="description" 
                id="ticketDescribe" 
                class="form-control border-bottom border-primary-400 rounded-bottom-0" 
                placeholder="請填寫套票描述（限 100 字）"
                maxlength="100"></textarea>
              </div>
              <p id="ticketDescribeError" class="text-danger small text-end d-none">填寫錯誤！</p>
            </div>
            <div class="d-flex justify-content-end">
              <button type="submit" 
              id="formSubmit" 
              value="新增套票" 
              class="btn btn-primary-400 btn-lg" >
              新增套票
            </div>
          </form>
        </div>
      </div>
    </section>
    <section class="py-10 bg-main">
      <div class="container mb-8">
        <div class="row align-items-start">
          <div class="col-10 d-flex align-items-center">
            <form class="me-5" style="width: 306px;">
              <div>
                <select name="areaFilter" id="areaFilter" class="form-select border">
                  <option selected disabled hidden>地區搜尋</option>
                  <option value="全部地區">全部地區</option>
                  <option value="台北">台北</option>
                  <option value="台中">台中</option>
                  <option value="高雄">高雄</option>
                </select>
              </div>
            </form>
            <p class="text-gray-500">本次搜尋共 <span class="filterResult">0</span> 筆資料</p>
          </div>
          <div class="col-2">
            <div id="chart"></div>
          </div>
        </div>
      </div>
      <section class="container">
        <ul class="row row-cols-md-3 list-unstyled gy-4" id="tourCard">

        </ul>
      </section>
    </section>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js">
    </script>
    <script>
      let ticketData ;
      const tourCard = document.querySelector("#tourCard");

      const areaFilter = document.querySelector("#areaFilter");
      const filterResult = document.querySelector(".filterResult");

      const formSubmit = document.querySelector("#formSubmit")
      const ticketForm =document.querySelector("#ticketForm");
      const ticketInput =document.querySelectorAll(".ticketInput");
      
      const ticketName=document.querySelector("#ticketName");
      const imgUrl=document.querySelector("#imgUrl");
      const areaSelect=document.querySelector("#areaSelect");
      const ticketPrice=document.querySelector("#ticketPrice");
      const ticketGroup=document.querySelector("#ticketGroup");
      const ticketRate=document.querySelector("#ticketRate");
      const ticketDescribe=document.querySelector("#ticketDescribe");

      const ticketNameError = document.querySelector('#ticketNameError');
      const ticketImgUrlError = document.querySelector('#ticketImgUrlError');
      const ticketAreaError = document.querySelector('#ticketAreaError');
      const ticketPriceError = document.querySelector('#ticketPriceError');
      const ticketGroupError = document.querySelector('#ticketGroupError');
      const ticketRateError = document.querySelector('#ticketRateError');
      const ticketDescribeError = document.querySelector('#ticketDescribeError');
      
      //串接商品data
      const apiUrl ='https://raw.githubusercontent.com/hexschool/js-training/main/travelApi.json';
      axios.get(apiUrl, {

        })
        .then(function (response) {
          
          ticketData = response.data.data;
          showTicketCard(ticketData);
          getChartData(ticketData);
          getChart();
          
        })
        .catch(function (error) {
          tourCard.outerHTML =`<p class="text-center display-1 text-danger fw-bold">資料載入失敗QQ</p>`;
        })
        .finally(function () {
          // always executed
        });   
        //渲染商品列表
        function showTicketCard(item){
            let cardTxt ='';
            item.forEach( v => {
              let txt = `
                <li class="col">
                  <div class="card position-relative">
                    <span class="tourArea badge bg-primary-300 label-md rounded-end-1 position-absolute top-0 start-0 translate-middle-y mt-2">${v.area}</span>
                  
                    <img class="tourImg card-img-top" src="${v.imgUrl}" alt="">
                    
                    <div class="card-body position-relative">
                      <span class="tourRank badge bg-primary-500 fs-6 rounded-end-1 position-absolute top-0 start-0 translate-middle-y">${v.rate}</span>
                      <h2 class="tourName card-title h4 pb-1 border-bottom border-3 border-primary-400">${v.name}</h2>
                      <p class="tourDescri">
                        ${v.description}
                      </p>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                      <p class="">剩下最後 <span class="tourGroup">${v.group}</span> 組</p>
                      <div class="d-flex">
                        <span class="py-3 me-1">TWD</span>
                        <span class="tourPrice label-xl ">${v.price}</span>
                      </div>
                    </div>
                  </div>
                </li>
              `
              cardTxt += txt;
            });
            tourCard.innerHTML=cardTxt;
            filterResult.textContent = item.length;
          }
        
        //篩選地區 監聽(我還不太懂我在幹嘛ㄆ)
        areaFilter.addEventListener("change", e=>{
          let selectedArea = e.target.value;  //取得選項的值並宣告selectedArea
          const ticketfilter = ticketData.filter(item =>item.area === selectedArea);  
                //找出 ticketData裡area屬性等於selectedArea的資料，變成新陣列
          if (selectedArea === '全部地區') {
            showTicketCard(ticketData);
          } else {
            showTicketCard(ticketfilter); 
                //"showTicketCard"的參數換成"ticketfilter"，表示函式裡改成用ticketfilter渲染
          }
        })
        //表單
        formSubmit.addEventListener('click', e =>{
          e.preventDefault();
          if (!validateForm()) {
            return alert('有些內容沒寫好~~');
          }
          const newTicket ={
            id : ticketData.length,
            name : ticketName.value.trim(),
            imgUrl : imgUrl.value.trim(),
            price : Number(ticketPrice.value) ,
            area : areaSelect.value,
            rate : Number(ticketRate.value),
            group : Number(ticketGroup.value),
            description : ticketDescribe.value.trim(),
          }
          ticketData.push(newTicket);

          showTicketCard(ticketData);
          getChartData(ticketData);
          chart.load({
            columns: chartData
          });
          ticketForm.reset();
          areaFilter.value ='全部地區';
        })
        //表單內容驗證
      function validateForm(){
        let isValid= true;

        const isNameError = ticketName.value.trim() === '';
        showInputError(ticketNameError, isNameError); 
        if (isNameError) { isValid = false; }

        const isImgUrlError = imgUrl.value.trim() === '';
        showInputError(ticketImgUrlError, isImgUrlError); 
        if (isImgUrlError) { isValid = false; }

        const isAreaError = areaSelect.value === '請選擇景點地區';
        showInputError(ticketAreaError, isAreaError);
        if (isAreaError) { isValid = false; }

        const price = Number(ticketPrice.value.trim());
        const isPriceError = isNaN(price) || price < 1;
        showInputError(ticketPriceError, isPriceError);
        if (isPriceError) { isValid = false; }

        const group = Number(ticketGroup.value.trim());
        const isGroupError = isNaN(group) || group < 1;
        showInputError(ticketGroupError, isGroupError);
        if (isGroupError) { isValid = false; }

        const rate = Number(ticketRate.value.trim());
        const isRateError = isNaN(rate) || rate < 1 || rate > 10;
        showInputError(ticketRateError, isRateError);
        if (isRateError) { isValid = false; }

        const isDescribeError = ticketDescribe.value.trim() === '';
        showInputError(ticketDescribeError, isDescribeError);
        if (isDescribeError) { isValid = false; }

        return isValid;
      }
        //表單錯誤訊息判斷
      function showInputError(item, isError){
        if (isError) {
            item.classList.remove('d-none');
        } else {
            item.classList.add('d-none');
        }
      }
    </script>
    <script>
      let chartData=[];
      let chart;

      function getChartData(data){
        chartData.length = 0;
        let obj ={};
        ticketData.forEach(item =>{
          if (obj[item.area] == undefined) {
            obj[item.area] = 1;
          } else {
            obj[item.area] += 1;
          }
        })
        
        let area = Object.keys(obj);
        area.forEach(item =>{
          let array = [];
          array.push(item);
          array.push(obj[item]);
          chartData.push(array);
        })
        return chartData;
      }
      
      function getChart(){
        chart = c3.generate({
        bindto: "#chart",
        data: {
          columns: chartData,
          type : 'donut',
          colors: {
            '台北': '#26C0C7',   
            '台中': '#5151D3' ,
            '高雄': '#E68618',    
        }
        },
        donut: {
          title: "旅遊地區",
          
        }
      });

      }

    </script>
    <script type="module" src="../main.js"></script>

  </body>
</html>
